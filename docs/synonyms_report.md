# Synonyms 巡检报告

该工具用于每周巡检 `configs/synonyms.yml` 中的显式同义分组，并对自动聚类结果、潜在的合并/拆分机会以及未分组的热门市场进行审计。生成的 Markdown 报告可直接提交到知识库或发送给运营团队，辅助人工维护。

## 报告内容

脚本输出的报告包含以下区块：

1. **【Section 1】总体概览**：纳入分析的市场数量、自动聚类数量、显式组数量、候选合并/拆分统计、纯历史组数量以及重要未分组市场数量。如果运行环境缺少 `numpy` 或 `sentence-transformers`，这里会给出提醒。
2. **【Section 2】显式分组健康检查**：逐个显式组列出成员表格、组内相似度统计、类别分布、缺失成员以及高相似度的组外候选市场。
3. **【Section 3】候选合并**：当自动聚类中出现多个显式组混在一起时，列出涉及的组、聚类相似度指标以及成员清单，方便人工判断是否应该合并。
4. **【Section 4】候选拆分**：当显式组内出现极低相似度或多种类别混杂时，列出拆分理由，并在可行时提供更细粒度的子簇建议。
5. **【Section 5】纯历史显式分组**：所有成员均已关闭且远离分析窗口的显式组，便于迁移到历史档案或删除。
6. **【Section 6】未分组但重要的市场**：未进入任何显式组、又缺乏可靠自动簇覆盖的市场。报告会展示成交量、自动簇规模以及最接近的若干邻居，辅助判断是否需要新增显式组。

## 运行方法

脚本位于 `scripts/synonyms_report.py`，可直接通过 `python -m` 来执行。常用示例：

```bash
python3 -m scripts.synonyms_report \
  --days-back 30 \
  --min-volume 10000 \
  --cutoff-days 90 \
  --output reports/synonyms_report_$(date +%F).md
```

- `--days-back`：只分析最近 N 天内活跃或未截止的市场。
- `--min-volume`：筛选“重要未分组市场”时使用的最小成交量阈值。
- `--cutoff-days`：判断“纯历史组”时的截止天数。
- `--output`：Markdown 报告写入路径，如 `reports/YYYY-MM-DD.md`。

脚本自动读取 `.env` 中的数据库与配置路径，复用既有 `Database`/`settings` 组件，无需额外环境变量。

## 使用建议

1. **例行执行**：建议通过 cron 或 GitHub Actions 每周执行一次，并将报告归档在 `reports/` 目录便于回溯。
2. **维护流程**：
   - Section 2 中若出现“缺失成员”或“组外候选”，可直接将对应 `condition_id` 添加到 `configs/synonyms.yml` 的 `explicit` 列表。
   - Section 3 的候选合并若确认需要整合，可统一到一个显式组，并删掉冗余的旧分组。
   - Section 4 的候选拆分如确实过宽，可按照子簇建议拆分为多个显式组。
   - Section 5 的条目可以迁移到 `synonyms_historical.yml`（如有），以保持线上配置精简。
   - Section 6 指出的市场，若频繁出现信号或成交量大，请评估是否纳入现有显式组或新增同义组。
3. **依赖检查**：自动聚类与相似度分析需要 `numpy` 与 `sentence-transformers`，请确保对应依赖在运行环境中可用；否则报告会标记缺失并跳过相关统计。

通过该报告，可以在不影响实时系统的前提下持续评估语义分组质量，及时发现同义匹配的盲区或漂移，保障后续规则/ML 信号的准确性。
